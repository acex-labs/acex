name: CI

on:
  push:
    branches: [ main ]

jobs:
  check-versions:
    name: Check version ${{ matrix.package }}
    runs-on: ubuntu-latest
    outputs:
      backend-should-publish: ${{ steps.check-backend.outputs.should-publish }}
      cli-should-publish: ${{ steps.check-cli.outputs.should-publish }}
      client-should-publish: ${{ steps.check-client.outputs.should-publish }}
      mcp-should-publish: ${{ steps.check-mcp.outputs.should-publish }}
    strategy:
      matrix:
        package: [backend, cli, client, mcp]
        include:
          - package: backend
            pypi-name: acex
          - package: cli
            pypi-name: acex-cli
          - package: client
            pypi-name: acex-client
          - package: mcp
            pypi-name: acex-mcp-server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
    
    - name: Get package version
      id: get-version
      working-directory: ./${{ matrix.package }}
      run: |
        VERSION=$(poetry version -s)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"
    
    - name: Check if version exists on PyPI
      id: check-pypi
      run: |
        PACKAGE_NAME="${{ matrix.pypi-name }}"
        VERSION="${{ steps.get-version.outputs.version }}"
        
        # Kolla om versionen redan finns på PyPI
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PACKAGE_NAME}/${VERSION}/json")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "should-publish=false" >> $GITHUB_OUTPUT
          echo "⏭️  Version $VERSION already exists on PyPI - skipping"
        else
          echo "should-publish=true" >> $GITHUB_OUTPUT
          echo "✅ Version $VERSION is new - will build and publish"
        fi
    
    - name: Set matrix output
      id: check-backend
      if: matrix.package == 'backend'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-cli
      if: matrix.package == 'cli'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-client
      if: matrix.package == 'client'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-mcp
      if: matrix.package == 'mcp'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT

  build-and-publish:
    name: Build & Publish ${{ matrix.package }}
    needs: check-versions
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Krävs för Trusted Publisher (OIDC)
      contents: read
    if: github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false  # Fortsätt med andra paket även om ett failar
      matrix:
        package: [backend, cli, mcp]
        include:
          - package: backend
            pypi-name: acex
            should-publish-output: backend-should-publish
          - package: cli
            pypi-name: acex-cli
            should-publish-output: cli-should-publish
          - package: client
            pypi-name: acex-client
            should-publish-output: client-should-publish
          - package: mcp
            pypi-name: acex-mcp-server
            should-publish-output: mcp-should-publish
    
    steps:
    - name: Check if should publish
      id: should-publish
      run: |
        SHOULD_PUBLISH="${{ needs.check-versions.outputs[matrix.should-publish-output] }}"
        echo "should-publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
        if [ "$SHOULD_PUBLISH" = "true" ]; then
          echo "✅ Will build and publish ${{ matrix.pypi-name }}"
        else
          echo "⏭️  Skipping ${{ matrix.pypi-name }} - already published"
        fi
    
    - name: Checkout code
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Update lock file
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry lock
    
    - name: Install dependencies - ${{ matrix.package }}
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry install --no-interaction
    
    - name: Build package
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry build
    
    - name: Publish to PyPI using Trusted Publisher
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ${{ matrix.package }}/dist/
        verbose: true

