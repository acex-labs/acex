name: CI

on:
  push:
    branches: [ main ]

jobs:
  check-versions:
    name: Check version ${{ matrix.package }}
    runs-on: ubuntu-latest
    outputs:
      backend-should-publish: ${{ steps.check-backend.outputs.should-publish }}
      cli-should-publish: ${{ steps.check-cli.outputs.should-publish }}
      client-should-publish: ${{ steps.check-client.outputs.should-publish }}
      mcp-should-publish: ${{ steps.check-mcp.outputs.should-publish }}
      devkit-should-publish: ${{ steps.check-devkit.outputs.should-publish }}
    strategy:
      matrix:
        package: [backend, cli, client, mcp, devkit]
        include:
          - package: backend
            pypi-name: acex
          - package: cli
            pypi-name: acex-cli
          - package: client
            pypi-name: acex-client
          - package: mcp
            pypi-name: acex-mcp-server
          - package: devkit
            pypi-name: acex-devkit
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
    
    - name: Get package version
      id: get-version
      working-directory: ./${{ matrix.package }}
      run: |
        VERSION=$(poetry version -s)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"
    
    - name: Check if version exists on PyPI
      id: check-pypi
      run: |
        PACKAGE_NAME="${{ matrix.pypi-name }}"
        VERSION="${{ steps.get-version.outputs.version }}"
        
        # Kolla om versionen redan finns på PyPI
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PACKAGE_NAME}/${VERSION}/json")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "should-publish=false" >> $GITHUB_OUTPUT
          echo "⏭️  Version $VERSION already exists on PyPI - skipping"
        else
          echo "should-publish=true" >> $GITHUB_OUTPUT
          echo "✅ Version $VERSION is new - will build and publish"
        fi
    
    - name: Set matrix output
      id: check-backend
      if: matrix.package == 'backend'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-cli
      if: matrix.package == 'cli'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-client
      if: matrix.package == 'client'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-mcp
      if: matrix.package == 'mcp'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
    
    - name: Set matrix output
      id: check-devkit
      if: matrix.package == 'devkit'
      run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT

  build-and-publish:
    name: Build & Publish ${{ matrix.package }}
    needs: check-versions
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Krävs för Trusted Publisher (OIDC)
      contents: read
    if: github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false  # Fortsätt med andra paket även om ett failar
      matrix:
        package: [backend, cli, client, mcp, devkit]
        include:
          - package: backend
            pypi-name: acex
            should-publish-output: backend-should-publish
          - package: cli
            pypi-name: acex-cli
            should-publish-output: cli-should-publish
          - package: client
            pypi-name: acex-client
            should-publish-output: client-should-publish
          - package: mcp
            pypi-name: acex-mcp-server
            should-publish-output: mcp-should-publish
          - package: devkit
            pypi-name: acex-devkit
            should-publish-output: devkit-should-publish
    
    steps:
    - name: Check if should publish
      id: should-publish
      run: |
        SHOULD_PUBLISH="${{ needs.check-versions.outputs[matrix.should-publish-output] }}"
        echo "should-publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
        if [ "$SHOULD_PUBLISH" = "true" ]; then
          echo "✅ Will build and publish ${{ matrix.pypi-name }}"
        else
          echo "⏭️  Skipping ${{ matrix.pypi-name }} - already published"
        fi
    
    - name: Checkout code
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install Poetry
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Update lock file
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry lock
    
    - name: Install dependencies - ${{ matrix.package }}
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry install --no-interaction

    - name: Switch acex-client dependency to version (prod)
      if: steps.should-publish.outputs.should-publish == 'true' && matrix.package == 'cli'
      working-directory: ./cli
      run: bash switch_acex_client_dep.sh prod
    
    - name: Switch dependencies to version (prod)
      if: steps.should-publish.outputs.should-publish == 'true' && matrix.package == 'client'
      working-directory: ./client
      run: bash switch_deps.sh prod
    
    - name: Build package
      if: steps.should-publish.outputs.should-publish == 'true'
      working-directory: ./${{ matrix.package }}
      run: poetry build
    
    - name: Publish to PyPI using Trusted Publisher
      if: steps.should-publish.outputs.should-publish == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ${{ matrix.package }}/dist/
        verbose: true


  # Drivers below, slightly different logic

  check-driver-versions:
    name: Check driver version ${{ matrix.driver }}
    runs-on: ubuntu-latest
    outputs:
      cisco-ios-cli-should-publish: ${{ steps.check-cisco-ios-cli.outputs.should-publish }}
      # juniper-junos-cli-should-publish: ${{ steps.check-juniper-junos-cli.outputs.should-publish }}
    strategy:
      matrix:
        driver: [cisco_ios_cli]
        include:
          - driver: cisco_ios_cli
            pypi-name: acex-driver-cisco-ioscli
          # - driver: juniper_junos_cli
          #   pypi-name: acex-driver-juniper-junoscli
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest

      - name: Get driver version
        id: get-version
        working-directory: ./drivers/${{ matrix.driver }}
        run: |
          VERSION=$(poetry version -s)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Driver version: $VERSION"

      - name: Check if driver version exists on PyPI
        id: check-pypi
        run: |
          PACKAGE_NAME="${{ matrix.pypi-name }}"
          VERSION="${{ steps.get-version.outputs.version }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/${PACKAGE_NAME}/${VERSION}/json")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "should-publish=false" >> $GITHUB_OUTPUT
            echo "⏭️  Version $VERSION already exists on PyPI - skipping"
          else
            echo "should-publish=true" >> $GITHUB_OUTPUT
            echo "✅ Version $VERSION is new - will build and publish"
          fi

      - name: Set matrix output
        id: check-cisco-ios-cli
        if: matrix.driver == 'cisco_ios_cli'
        run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT
      # - name: Set matrix output
      #   id: check-juniper-junos-cli
      #   if: matrix.driver == 'juniper_junos_cli'
      #   run: echo "should-publish=${{ steps.check-pypi.outputs.should-publish }}" >> $GITHUB_OUTPUT

  build-and-publish-drivers:
    name: Build & Publish Driver ${{ matrix.driver }}
    needs: check-driver-versions
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        driver: [cisco_ios_cli]
        include:
          - driver: cisco_ios_cli
            pypi-name: acex-driver-cisco-ioscli
            should-publish-output: cisco-ios-cli-should-publish
          # - driver: juniper_junos_cli
          #   pypi-name: acex-driver-juniper-junoscli
          #   should-publish-output: juniper-junos-cli-should-publish
    steps:
      - name: Check if should publish
        id: should-publish
        run: |
          SHOULD_PUBLISH="${{ needs.check-driver-versions.outputs[matrix.should-publish-output] }}"
          echo "should-publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
          if [ "$SHOULD_PUBLISH" = "true" ]; then
            echo "✅ Will build and publish ${{ matrix.pypi-name }}"
          else
            echo "⏭️  Skipping ${{ matrix.pypi-name }} - already published"
          fi

      - name: Checkout code
        if: steps.should-publish.outputs.should-publish == 'true'
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        if: steps.should-publish.outputs.should-publish == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        if: steps.should-publish.outputs.should-publish == 'true'
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Update lock file
        if: steps.should-publish.outputs.should-publish == 'true'
        working-directory: ./drivers/${{ matrix.driver }}
        run: poetry lock

      - name: Install dependencies - ${{ matrix.driver }}
        if: steps.should-publish.outputs.should-publish == 'true'
        working-directory: ./drivers/${{ matrix.driver }}
        run: poetry install --no-interaction

      - name: Build driver package
        if: steps.should-publish.outputs.should-publish == 'true'
        working-directory: ./drivers/${{ matrix.driver }}
        run: poetry build

      - name: Publish to PyPI using Trusted Publisher
        if: steps.should-publish.outputs.should-publish == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: drivers/${{ matrix.driver }}/dist/
          verbose: true